# Getting Started with Guardrails

This guide walks you through setting up the minimal working Guardrails system for GitHub Copilot security scanning.

## System Overview

Guardrails consists of two main components:

1. **FastAPI Backend** - Analyzes code for security violations
2. **GitHub App (Probot)** - Listens to PRs and posts comments

## Step 1: Start the Backend

### Option A: Direct Python (Recommended for Development)

```bash
cd backend
pip install -r requirements.txt
python main.py
```

Expected output:
```
INFO:     Uvicorn running on http://0.0.0.0:8000
```

Test it:
```bash
curl http://localhost:8000/health
# Response: {"status": "healthy", "version": "0.1.0"}
```

### Option B: Docker

```bash
cd backend
docker build -t guardrails-backend .
docker run -p 8000:8000 guardrails-backend
```

## Step 2: Create GitHub App

1. Go to: https://github.com/settings/apps/new

2. Fill in the form:
   - **App name:** `guardrails` (or your preferred name)
   - **Homepage URL:** `https://example.com`
   - **Webhook URL:** For local dev, use Smee (see below)
   - **Webhook secret:** Generate a random string

3. Set Permissions:
   - **Contents:** `Read`
   - **Pull requests:** `Write`
   - **Issues:** `Write`
   - **Metadata:** `Read`

4. Subscribe to Events:
   - Check `pull_request`
   - Check `issues`

5. Save and Generate Private Key:
   - Click "Generate a private key"
   - Save the `.pem` file somewhere safe

6. Take note of your **App ID**

## Step 3: Set Up Webhook (Local Development)

For local development, use Smee to forward webhooks:

```bash
# In a new terminal window
npx smee-client
```

You'll get output like:
```
Forwarding https://smee.io/xxxxxxx to http://127.0.0.1:3000/webhook
```

Go back to GitHub App settings and set:
- **Webhook URL:** `https://smee.io/xxxxxxx`

In another terminal, keep Smee listening:
```bash
npx smee-client -u https://smee.io/xxxxxxx -t http://localhost:3000/api/github/webhooks
```

## Step 4: Start the GitHub App

Create a `.env` file in `guardrails-github-app/`:

```bash
APP_ID=your-app-id-here
PRIVATE_KEY="-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEA...
...
-----END RSA PRIVATE KEY-----"
WEBHOOK_SECRET=your-webhook-secret-here
BACKEND_URL=http://localhost:8000
```

Or export as environment variables:

```bash
export APP_ID=your-app-id
export PRIVATE_KEY="$(cat /path/to/private-key.pem)"
export WEBHOOK_SECRET=your-secret
export BACKEND_URL=http://localhost:8000
```

Then start the app:

```bash
cd guardrails-github-app
npm install
npm run build
npm start
```

Expected output:
```
Listening on http://0.0.0.0:3000
```

## Step 5: Install App on a Repository

1. Go to: https://github.com/settings/apps/your-app-name

2. Click "Install App" or "Create Installation"

3. Select the repositories you want to monitor

4. Authorize the installation

## Step 6: Test with a PR

Create a test PR with code that violates security rules:

1. Create a new branch in your test repository:
```bash
git checkout -b test-guardrails
```

2. Add code with a security issue:
```python
# test.py
api_key = "sk-1234567890"
password = "super_secret_pass"
```

3. Commit and push:
```bash
git add test.py
git commit -m "Test guardrails scanning"
git push origin test-guardrails
```

4. Create a Pull Request on GitHub

5. **Within seconds**, Guardrails should post a comment like:

```
## ğŸ” Guardrails Security Scan

**Scan ID:** `scan-uuid-123`

### Summary
- **Total Issues:** 2
- ğŸ”´ **Critical:** 2

### ğŸ”´ CRITICAL Issues

<details>
<summary><b>Hardcoded API Key</b> (SEC-001) in test.py:2</summary>

**Issue:** Hardcoded API Key detected in source code.

**Code:**
```
api_key = "sk-1234567890"
```

**CWE:** CWE-798
**OWASP:** A02:2021 â€“ Cryptographic Failures

</details>

<details>
<summary><b>Hardcoded Secret</b> (SEC-001) in test.py:3</summary>

**Issue:** Hardcoded Secret detected in source code.

**Code:**
```
password = "super_secret_pass"
```

**CWE:** CWE-798
**OWASP:** A02:2021 â€“ Cryptographic Failures

</details>

---
**Policy:** Advisory Mode - Review these issues before merge.
*Generated by Guardrails Security Scanner*
```

## Available Security Rules

The backend detects:

- **SEC-001** - Hardcoded Secrets
  - API keys, passwords, tokens, AWS credentials
  - Severity: CRITICAL

- **SEC-002** - SQL Injection
  - String interpolation in SQL queries
  - Severity: CRITICAL

- **SEC-003** - Insecure Deserialization
  - pickle.loads(), unsafe YAML
  - Severity: HIGH

- **SEC-004** - Unsafe Code Execution
  - eval(), exec(), os.system()
  - Severity: CRITICAL

- **SEC-005** - Weak Cryptography
  - MD5, SHA1, DES
  - Severity: HIGH

## Troubleshooting

### Backend not responding

```bash
# Check if backend is running
curl http://localhost:8000/health

# Should return:
# {"status": "healthy", "version": "0.1.0"}
```

### GitHub App not triggering

1. **Check webhook delivery:**
   - Go to GitHub App settings â†’ Advanced â†’ Recent Deliveries
   - Look for your test PR
   - Check for any errors

2. **Verify environment variables:**
```bash
echo $APP_ID
echo $WEBHOOK_SECRET
echo $BACKEND_URL
```

3. **Check logs:**
```bash
# In guardrails-github-app terminal
npm run dev  # For debug logging
```

### No violations detected

- Backend might not be running
- File might have unsupported extension
- Code might not match detection patterns

Test the backend directly:

```bash
curl -X POST http://localhost:8000/api/analyze \
  -H "Content-Type: application/json" \
  -d '{
    "repo_name": "test/repo",
    "pr_number": 1,
    "commit_hash": "abc123",
    "files": {
      "test.py": "+api_key = \"sk-123\"\n"
    }
  }'
```

Should return violations.

### API Key issues

1. Verify APP_ID matches GitHub App settings
2. Verify PRIVATE_KEY file is valid PEM format
3. Verify WEBHOOK_SECRET matches GitHub settings

## Next Steps

### Configure Policies

Edit `backend/guardrails-config.yml`:

```yaml
enforcement_mode: warning  # or blocking, advisory

security:
  enabled: true
  block_on_critical: true
```

### Add Custom Rules

Edit `backend/app/rules/security_rules.py` to add new patterns.

### Deploy to Production

See deployment guides in:
- [Backend README](../backend/README.md)
- [GitHub App README](../guardrails-github-app/README.md)

## Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GitHub Repository  â”‚
â”‚    (PR created)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   GitHub Webhook    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼ (if local dev, via Smee)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GitHub App (Port 3000)
â”‚ - Listens to PR events
â”‚ - Fetches diff
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ HTTP POST /api/analyze
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FastAPI Backend (Port 8000)
â”‚ - Analyzes code
â”‚ - Detects violations
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ Returns JSON
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GitHub App
â”‚ - Formats comment
â”‚ - Posts to PR
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Key Files

- `backend/app/rules/security_rules.py` - Security detection rules
- `backend/app/analyzers/code_analyzer.py` - Diff parser
- `backend/app/models/violation.py` - Data models
- `guardrails-github-app/src/index.ts` - GitHub App main logic
- `guardrails-config.yml` - Policy configuration

## Performance Tips

1. **Large PRs:** Backend processes files in parallel
2. **Rate Limiting:** Respects GitHub API limits
3. **Timeouts:** Default 30s per PR

## Security Considerations

- âœ… No source code is stored
- âœ… Analysis happens in-memory
- âœ… Secrets are never logged
- âœ… HTTPS communication
- âœ… Webhook signature validation

## Support

For issues:

1. Check [Main README](../README.md)
2. Check [Backend README](../backend/README.md)
3. Check [GitHub App README](../guardrails-github-app/README.md)
4. Review logs in both components

## Next: Advanced Setup

Once basic setup works, explore:

- Custom rule packs
- Blocking enforcement mode
- Integration with CI/CD
- Custom Copilot detection
- Enterprise dashboard (future feature)

Good luck! ğŸš€
